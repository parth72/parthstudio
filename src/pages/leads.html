<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Studio Manager — Leads</title>

<link rel="stylesheet" href="../css/tokens.css">
<link rel="stylesheet" href="../css/components.css">
<link rel="stylesheet" href="../css/styles.css">

<style>
:root{ --muted: rgba(255,255,255,0.6); }
html,body{height:100%;margin:0;background:linear-gradient(140deg,#0c252c,#132c33);-webkit-font-smoothing:antialiased;font-family:Inter,system-ui,Roboto;color:#eaf6ff}
.app{max-width:1200px;margin:28px auto;border-radius:18px;display:grid;grid-template-columns:260px 1fr;padding:18px;min-height:76vh;background:linear-gradient(180deg, rgba(255,255,255,0.015), rgba(255,255,255,0.01));border:1px solid rgba(255,255,255,0.03);box-shadow:0 20px 60px rgba(2,10,15,0.6)}
.sidebar{padding:22px;display:flex;flex-direction:column;gap:18px;background:linear-gradient(180deg, rgba(3,12,16,0.6), rgba(2,8,12,0.55));border-radius:12px}
.brand{font-weight:700;font-size:18px}
.nav{display:flex;flex-direction:column;gap:8px;margin-top:6px}
.nav button{all:unset;display:flex;align-items:center;gap:10px;padding:10px;border-radius:10px;color:var(--muted);cursor:pointer}
.nav button.active{background:linear-gradient(180deg, rgba(255,255,255,0.02), rgba(255,255,255,0.01));color:#eaf6ff}
.main{padding:22px;display:grid;grid-template-columns:1fr;gap:20px}
.header{display:flex;justify-content:space-between;align-items:center}
.title{font-size:28px;font-weight:700;margin:0}
.subtitle{color:var(--muted);margin-top:6px}
.list{display:flex;flex-direction:column;gap:10px;margin-top:12px}
.lead-card{background:linear-gradient(180deg, rgba(255,255,255,0.02), rgba(255,255,255,0.01));padding:12px;border-radius:10px;border:1px solid rgba(255,255,255,0.03);display:flex;justify-content:space-between;align-items:center}
.lead-left{display:flex;gap:12px;align-items:center}
.badge{padding:6px 8px;border-radius:8px;background:rgba(255,255,255,0.03);font-size:12px}
.btn{padding:8px 10px;border-radius:8px;border:none;background:#1e90ff;color:#fff;cursor:pointer}
.ghost{background:transparent;color:rgba(255,255,255,0.9);border:1px solid rgba(255,255,255,0.06);padding:8px 10px;border-radius:8px;cursor:pointer}
.modal-backdrop{position:fixed;inset:0;background:rgba(0,0,0,0.45);display:none;z-index:1200}
.modal{position:fixed;left:50%;top:50%;transform:translate(-50%,-50%);width:720px;max-width:95%;background:linear-gradient(180deg,rgba(255,255,255,0.02),rgba(255,255,255,0.01));border-radius:12px;padding:18px;border:1px solid rgba(255,255,255,0.03);z-index:1300;display:none}
.thread{margin-top:12px;display:flex;flex-direction:column;gap:8px;max-height:240px;overflow:auto;padding-right:6px}
.thread .item{background:rgba(255,255,255,0.02);padding:8px;border-radius:8px}
@media (max-width:980px){ .app{grid-template-columns:1fr;padding:12px} .main{grid-template-columns:1fr;padding:12px} .modal{width:95%} }
</style>
</head>
<body>
<div class="app">
  <aside class="sidebar">
    <div class="brand">Studio Manager</div>
    <nav class="nav">
      <button onclick="location.href='dashboard.html'">Dashboard</button>
      <button onclick="location.href='projects.html'">Projects</button>
      <button onclick="location.href='invoices.html'">Invoices</button>
      <button onclick="location.href='clients.html'">Clients</button>
      <button class="active">Leads</button>
      <button onclick="location.href='portfolio-public.html'">Portfolio</button>
      <button onclick="location.href='team.html'">Team</button>
    </nav>
    <div style="margin-top:auto;">
      <div class="mini" style="margin-bottom:8px;">Logged as <b id="whoAmI">—</b></div>
      <button id="logoutBtn" class="ghost">⟲</button>
    </div>
  </aside>

  <main class="main">
    <div class="header">
      <div>
        <div class="title">Leads</div>
        <div class="subtitle">Incoming contact messages — reply from here</div>
      </div>
      <div>
        <input id="searchBox" class="input" placeholder="Search leads..." />
      </div>
    </div>

    <div id="list" class="list" aria-live="polite"></div>
  </main>
</div>

<!-- modal -->
<div id="modalBackdrop" class="modal-backdrop" aria-hidden="true"></div>
<div id="modal" class="modal" role="dialog" aria-modal="true" aria-hidden="true"></div>

<script src="/env.js"></script>
<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js/dist/umd/supabase.min.js"></script>

<script>
/*
 Leads page
 - Replies are appended to leads.thread JSON as objects:
   { from, to, body, at, status: 'queued' }
 - Apps Script runQueue() should poll Supabase and send queued emails.
*/

(async function(){
  const SUPABASE_URL = window.SUPABASE_URL || '';
  const SUPABASE_ANON_KEY = window.SUPABASE_ANON_KEY || '';
  if(!SUPABASE_URL || !SUPABASE_ANON_KEY){ document.body.innerHTML = '<div style="padding:24px;color:#ff9b9b">Missing env.js</div>'; return; }
  const supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

  // session + me
  let me = 'admin';
  try {
    const { data: { session } } = await supabase.auth.getSession();
    if(!session || !session.user) return window.location.href = 'login.html';
    me = session.user.email || 'admin';
    document.getElementById('whoAmI').innerText = me.split('@')[0] || me;
  } catch(e){ console.error('session', e); window.location.href='login.html'; return; }

  document.getElementById('logoutBtn').addEventListener('click', async ()=> { await supabase.auth.signOut(); window.location.href='login.html'; });

  // helpers
  async function fetchTable(table, opts={}) {
    let q = supabase.from(table).select(opts.select || '*');
    if(opts.order) q = q.order(opts.order[0], { ascending: !!opts.order[1] });
    if(opts.limit) q = q.limit(opts.limit);
    const { data, error } = await q;
    if(error) console.warn('fetch', table, error);
    return { data, error };
  }
  async function updateRow(table, idField, idValue, payload){ const { data, error } = await supabase.from(table).update(payload).eq(idField, idValue).select(); if(error) throw error; return data; }
  async function logActivity({ type, actor, detail }){ try { await supabase.from('activity').insert({ type, actor, detail, created_at: new Date().toISOString() }); } catch(e){ console.warn('logActivity', e); } }

  // modal helpers
  const modal = document.getElementById('modal'), backdrop = document.getElementById('modalBackdrop');
  function openModal(html){ modal.innerHTML = html; backdrop.style.display = 'block'; modal.style.display = 'block'; backdrop.setAttribute('aria-hidden','false'); modal.setAttribute('aria-hidden','false'); const first = modal.querySelector('textarea, input, button'); if(first) first.focus(); }
  function closeModal(){ modal.style.display = 'none'; backdrop.style.display = 'none'; modal.innerHTML = ''; backdrop.setAttribute('aria-hidden','true'); modal.setAttribute('aria-hidden','true'); }
  backdrop.addEventListener('click', closeModal);

  // data + render
  let leads = [];
  async function loadLeads(){
    const res = await fetchTable('leads', { order:['created_at', false] });
    leads = (res && res.data) ? res.data : [];
    renderList();
  }

  function renderList(){
    const list = document.getElementById('list'); list.innerHTML = '';
    if(!leads.length){ list.innerHTML = '<div class="lead-card">No leads yet</div>'; return; }
    const q = (document.getElementById('searchBox').value||'').toLowerCase();
    leads.filter(l=> !q || (l.name||'').toLowerCase().includes(q) || (l.email||'').toLowerCase().includes(q) || (l.message||'').toLowerCase().includes(q))
      .forEach(l=>{
        const el = document.createElement('div'); el.className='lead-card';
        el.innerHTML = `<div class="lead-left"><div style="width:46px;height:46px;border-radius:8px;background:linear-gradient(180deg,#22586a,#14313a);display:grid;place-items:center;font-weight:700">${(l.name||'U').split(' ').map(x=>x[0]).slice(0,2).join('')}</div><div style="min-width:0"><div style="font-weight:700;color:#f7fbff">${l.name||'(no name)'}</div><div style="color:var(--muted);font-size:13px">${l.email||''} · ${new Date(l.created_at).toLocaleString()}</div></div></div><div style="display:flex;gap:8px;align-items:center"><div class="badge">${l.status||'new'}</div><button class="ghost" data-id="${l.id}" data-action="view">View</button><button class="btn" data-id="${l.id}" data-action="reply">Reply</button><button class="ghost" data-id="${l.id}" data-action="delete">Delete</button></div>`;
        list.appendChild(el);
    });
  }

  document.getElementById('searchBox').addEventListener('input', renderList);

  // actions
  document.getElementById('list').addEventListener('click', async (e)=>{
    const btn = e.target.closest('button'); if(!btn) return;
    const id = btn.dataset.id, action = btn.dataset.action;
    const lead = leads.find(x => String(x.id) === String(id));
    if(!lead) return;
    if(action === 'view'){
      const thread = Array.isArray(lead.thread) ? lead.thread : (lead.thread ? JSON.parse(lead.thread) : []);
      const threadHtml = (thread.length ? thread.map(t=>`<div class="item"><div style="font-weight:700">${t.from}</div><div style="font-size:13px">${t.body}</div><div style="font-size:12px;color:rgba(255,255,255,0.55)">${t.at}</div></div>`).join('') : '<div class="item">No thread</div>');
      openModal(`<div><h3 style="margin:0 0 8px 0">${lead.name || lead.email}</h3><div style="color:var(--muted)">${lead.email||''}</div><div style="margin-top:12px">${lead.message||''}</div><div class="thread">${threadHtml}</div><div style="margin-top:12px"><button class="ghost" onclick="document.getElementById('modalBackdrop').click()">Close</button></div></div>`);
    } else if(action === 'reply'){
      openModal(`<div><h3 style="margin:0 0 8px 0">Reply to ${lead.name||lead.email}</h3>
        <div style="color:var(--muted);margin-bottom:8px">${lead.email}</div>
        <textarea id="replyBody" placeholder="Write your reply..." style="width:100%;height:140px;padding:10px;border-radius:8px;border:1px solid rgba(255,255,255,0.04);background:rgba(255,255,255,0.02);color:#eaf6ff"></textarea>
        <div style="margin-top:10px;display:flex;gap:8px;justify-content:flex-end"><button id="cancel" class="ghost">Cancel</button><button id="send" class="btn">Queue Reply</button></div></div>`);
      document.getElementById('cancel').onclick = closeModal;
      document.getElementById('send').onclick = async ()=>{
        const body = document.getElementById('replyBody').value.trim();
        if(!body) return alert('Type reply');
        closeModal();
        try {
          // fetch latest thread (fresh read)
          const { data: fresh } = await supabase.from('leads').select('thread,status').eq('id', lead.id).single();
          let thread = [];
          if(fresh && fresh.thread){
            thread = Array.isArray(fresh.thread) ? fresh.thread : JSON.parse(fresh.thread);
          }
          const entry = { from: me, to: lead.email, body, at: new Date().toISOString(), status: 'queued' };
          thread.push(entry);
          // write back thread and set lead status 'contacted'
          await updateRow('leads','id', lead.id, { thread, status: 'contacted', updated_at: new Date().toISOString() });
          await logActivity({ type:'lead.reply', actor: me, detail: `Queued reply to ${lead.email}` });
          await loadLeads();
          alert('Reply queued. Apps Script will send it.');
        } catch(err){
          console.error(err);
          alert('Queue failed: ' + (err?.message || err));
        }
      };
    } else if(action === 'delete'){
      if(!confirm('Delete lead?')) return;
      try {
        await updateRow('leads','id', lead.id, { deleted_at: new Date().toISOString() }); // keep RLS-friendly; but you wanted hard delete - replace with deleteRow if you want true hard delete
        await logActivity({ type:'lead.delete', actor: me, detail: `Deleted lead ${lead.email||lead.name}` });
        await loadLeads();
      } catch(e){ alert('Delete failed'); console.error(e); }
    }
  });

  // update helper (re-using updateRow declared)
  async function updateRow(table, idField, idValue, payload){ const { data, error } = await supabase.from(table).update(payload).eq(idField, idValue).select(); if(error) throw error; return data; }

  // init
  await loadLeads();

})();
</script>
</body>
</html>