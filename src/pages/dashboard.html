<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Studio Manager â€” Dashboard</title>

<link rel="stylesheet" href="../css/tokens.css">
<link rel="stylesheet" href="../css/components.css">
<link rel="stylesheet" href="../css/styles.css">

<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

<style>
:root{ --card-radius:14px; --gap:18px; }
html,body{height:100%;margin:0;background: linear-gradient(140deg,#0c252c,#132c33);font-family:Inter,system-ui,Roboto;color:#eaf6ff}
.app{max-width:1200px;margin:30px auto;border-radius:18px;display:grid;grid-template-columns:260px 1fr;padding:18px;min-height:74vh;background:linear-gradient(180deg, rgba(255,255,255,0.015), rgba(255,255,255,0.01));border:1px solid rgba(255,255,255,0.03);box-shadow:0 20px 60px rgba(2,10,15,0.6)}
.sidebar{padding:26px 18px;display:flex;flex-direction:column;gap:18px;background:linear-gradient(180deg, rgba(3,12,16,0.6), rgba(2,8,12,0.55));border-radius:12px}
.brand{font-weight:700;font-size:18px}
.nav{display:flex;flex-direction:column;gap:10px;margin-top:6px}
.nav button{all:unset;display:flex;align-items:center;gap:12px;padding:12px;border-radius:12px;color:rgba(255,255,255,0.6);cursor:pointer}
.nav button.active{background:linear-gradient(180deg, rgba(255,255,255,0.02), rgba(255,255,255,0.01));color:#eaf6ff}
.main{padding:22px;display:grid;grid-template-columns:1fr 360px;gap:20px}
.header{grid-column:1 / -1;display:flex;justify-content:space-between;align-items:flex-start;gap:12px}
.title{font-size:36px;font-weight:700;margin:0}
.subtitle{color:rgba(255,255,255,0.6);margin-top:4px}
.search{grid-column:1 / -1;margin-top:10px}
.search input{width:100%;padding:12px 14px;border-radius:12px;background:rgba(255,255,255,0.02);border:1px solid rgba(255,255,255,0.02);color:#eaf6ff;outline:none}

/* left grid */
.left-grid{display:grid;grid-template-columns:repeat(2, minmax(0,1fr));gap:16px;margin-top:12px}
.card{background:linear-gradient(180deg, rgba(255,255,255,0.02), rgba(255,255,255,0.01));border-radius:var(--card-radius);padding:16px;border:1px solid rgba(255,255,255,0.03);box-shadow:0 8px 26px rgba(2,8,12,0.36);color:rgba(255,255,255,0.8)}
.card h3{margin:0;font-size:13px;font-weight:600;color:rgba(255,255,255,0.6)}
.card .big{font-size:28px;font-weight:700;color:#f7fbff;margin-top:8px}

/* revenue */
.revenue-card{grid-column:1 / 3;display:flex;gap:12px;align-items:center;justify-content:space-between;min-height:140px;padding:18px}
.revenue-canvas{width:320px;height:110px}

/* activity */
.activity-list{display:flex;flex-direction:column;gap:10px;max-height:260px;overflow:auto;padding-right:6px}
.act-item{display:flex;justify-content:space-between;align-items:flex-start;padding:10px;border-radius:10px;background:rgba(255,255,255,0.005)}
.avatar{width:36px;height:36px;background:linear-gradient(180deg,#22586a,#14313a);border-radius:8px;display:grid;place-items:center;color:#eaf6ff;font-weight:700}

/* right column */
.right-col{display:flex;flex-direction:column;gap:16px}
.note-card{background:linear-gradient(180deg, rgba(255,255,255,0.015), rgba(255,255,255,0.01));padding:12px;border-radius:10px;border:1px solid rgba(255,255,255,0.03);min-height:70px;color:rgba(255,255,255,0.8)}
.control-btn{background:rgba(255,255,255,0.03);width:44px;height:44px;border-radius:50%;display:grid;place-items:center;border:1px solid rgba(255,255,255,0.03);cursor:pointer}

/* notif drawer */
.notif-drawer{position:fixed;right:22px;top:86px;width:320px;background:linear-gradient(180deg,rgba(255,255,255,0.02),rgba(255,255,255,0.01));border-radius:12px;padding:12px;box-shadow:0 12px 40px rgba(0,0,0,0.6);border:1px solid rgba(255,255,255,0.03);display:none;z-index:1200}

/* responsive */
@media (max-width:980px){
  .app{grid-template-columns:1fr;padding:12px}
  .main{grid-template-columns:1fr;padding:12px}
  .left-grid{grid-template-columns:1fr}
  .revenue-card{grid-column:1 / -1}
  .right-col{order:3}
}
</style>
</head>
<body>

<div class="app" role="application" aria-label="Studio Manager Dashboard">
  <aside class="sidebar" aria-label="Sidebar">
    <div class="brand">Studio Manager</div>
    <nav class="nav" aria-label="Main navigation">
      <button class="active" onclick="location.href='dashboard.html'">Dashboard</button>
      <button onclick="location.href='projects.html'">Projects</button>
      <button onclick="location.href='invoices.html'">Invoices</button>
      <button onclick="location.href='clients.html'">Clients</button>
      <button onclick="location.href='leads.html'">Leads</button>
      <button onclick="location.href='portfolio-public.html'">Portfolio</button>
      <button onclick="location.href='team.html'">Team</button>
    </nav>

    <div style="margin-top:auto;">
      <div class="mini" style="margin-bottom:8px;">Logged as <b id="whoAmI">â€”</b></div>
      <button id="logoutBtn" class="control-btn" title="Logout">âŸ²</button>
    </div>
  </aside>

  <main class="main" id="mainApp">
    <div class="header">
      <div>
        <div class="title">Dashboard</div>
        <div class="subtitle">Overview â€” Clients, Projects, Invoices & Leads</div>
      </div>

      <div class="controls" style="display:flex;gap:10px;align-items:center">
        <button id="notifyBtn" class="control-btn" title="Notifications">ðŸ”” <span id="notifBadge" style="display:none;background:#ff6b6b;padding:3px 6px;border-radius:8px;font-size:12px;margin-left:6px;"></span></button>
        <button id="quickAdd" class="control-btn" title="Quick add">ï¼‹</button>
      </div>
    </div>

    <div class="search" style="grid-column:1 / -1;">
      <input id="searchInput" placeholder="Search clients, projects, invoices..." aria-label="Search"/>
    </div>

    <section class="left-grid" style="grid-column:1 / 2;">
      <div class="card">
        <h3>Total Clients</h3>
        <div class="big" id="totalClients">â€”</div>
        <div class="mini">Active Â· <span id="clientsActive">â€”</span></div>
      </div>

      <div class="card">
        <h3>Total Projects</h3>
        <div class="big" id="totalProjects">â€”</div>
        <div class="mini">In Progress Â· <span id="projectsInProgress">â€”</span></div>
      </div>

      <div class="card leads">
        <h3>Leads Overview</h3>
        <div class="bar" aria-hidden="true" style="height:10px;background:rgba(255,255,255,0.03);border-radius:10px;overflow:hidden;position:relative">
          <i id="leadBarSegment" style="height:10px;display:block;background:linear-gradient(90deg,#6fb0d9,#4e9cc7);width:40%;position:absolute;left:0;top:0;border-radius:10px;"></i>
        </div>
        <div style="display:flex;justify-content:space-between;margin-top:10px">
          <div class="mini"><span style="display:inline-block;width:10px;height:10px;background:#6fb0d9;border-radius:50%;margin-right:8px;"></span>New</div>
          <div class="mini"><span style="display:inline-block;width:10px;height:10px;background:rgba(255,255,255,0.06);border-radius:50%;margin-right:8px;"></span>Converted</div>
        </div>
      </div>

      <div class="card">
        <h3>Sticky Notes</h3>
        <div class="note-card" id="stickyText" contenteditable>Click to edit your main note...</div>
      </div>

      <div class="card revenue-card">
        <div class="revenue-left">
          <h3>Monthly Revenue</h3>
          <div class="mini">Last 7 months â€” totals in â‚¹</div>
          <div style="height:6px"></div>
          <div style="font-weight:700;font-size:20px;color:#f7fbff;margin-top:8px;">â‚¹ <span id="totalRevenueBig">â€”</span></div>
        </div>
        <div class="revenue-canvas"><canvas id="revenueChart" style="width:100%;height:100%"></canvas></div>
      </div>

      <div class="card">
        <h3>Recent Activity</h3>
        <div class="activity-list" id="activityList"></div>
      </div>
    </section>

    <aside class="right-col" style="grid-column:2 / 3;">
      <div class="card deadlines">
        <h3>Upcoming Deadlines</h3>
        <div id="deadlinesList" style="margin-top:10px"></div>
      </div>

      <div class="card">
        <h3>Activity Log</h3>
        <div class="muted" style="font-size:13px">Auto-logged events & automations</div>
        <div style="height:8px"></div>
        <div style="display:flex;gap:10px;margin-top:8px"><div class="mini">Overdue: <b id="overdueCount">0</b></div><div class="mini">Reminders: <b id="remindersCount">0</b></div></div>
      </div>
    </aside>
  </main>
</div>

<div id="notifDrawer" class="notif-drawer" aria-hidden="true"></div>

<script src="/env.js"></script>
<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js/dist/umd/supabase.min.js"></script>

<script>
(async function(){

  const SUPABASE_URL = window.SUPABASE_URL || '';
  const SUPABASE_ANON_KEY = window.SUPABASE_ANON_KEY || '';

  if(!SUPABASE_URL || !SUPABASE_ANON_KEY){
    document.getElementById('mainApp').innerHTML = '<div style="padding:32px;color:#ff9b9b">App misconfigured. Add env.js with SUPABASE_URL and SUPABASE_ANON_KEY.</div>';
    return;
  }

  const supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

  // session + me
  let me = 'admin';
  try {
    const { data: { session } } = await supabase.auth.getSession();
    if(!session || !session.user) { window.location.href = 'login.html'; return; }
    const email = session.user.email || 'admin';
    document.getElementById('whoAmI').innerText = email.split('@')[0] || email;
    me = email;
  } catch(e){ console.error('session', e); window.location.href='login.html'; return; }

  // logout
  document.getElementById('logoutBtn').addEventListener('click', async ()=> {
    await supabase.auth.signOut();
    window.location.href = 'login.html';
  });

  // minimal SM_API helpers
  async function fetchTable(table, opts = {}) {
    let q = supabase.from(table).select(opts.select || '*');
    if(opts.eq){ const key = Object.keys(opts.eq)[0]; q = q.eq(key, opts.eq[key]); }
    if(opts.order) q = q.order(opts.order[0], { ascending: !!opts.order[1] });
    if(opts.limit) q = q.limit(opts.limit);
    const { data, error } = await q;
    if(error) { console.warn('fetchTable', table, error); return { data: [], error }; }
    return { data, error };
  }
  async function insertRow(table, payload){ const { data, error } = await supabase.from(table).insert(payload).select(); return { data, error }; }
  async function updateRow(table, idField, idValue, payload){ const { data, error } = await supabase.from(table).update(payload).eq(idField, idValue).select(); return { data, error }; }
  async function deleteRow(table, idField, idValue){ const { data, error } = await supabase.from(table).delete().eq(idField, idValue).select(); return { data, error }; }
  async function logActivity({ type, actor, detail='' }){ try { await insertRow('activity', { type, actor, detail, created_at: new Date().toISOString() }); } catch(e){ console.warn('logActivity', e); } }

  const demo = { clients:[], projects:[], leads:[], activity:[] };

  async function loadAll(){
    const [cRes, pRes, lRes, aRes] = await Promise.all([
      fetchTable('clients', { order:['created_at', false] }),
      fetchTable('projects', { order:['created_at', false] }),
      fetchTable('leads', { order:['created_at', false] }),
      fetchTable('activity', { order:['created_at', false], limit: 50 })
    ]);
    demo.clients = (cRes && cRes.data) ? cRes.data : [];
    demo.projects = (pRes && pRes.data) ? pRes.data : [];
    demo.leads = (lRes && lRes.data) ? lRes.data : [];
    demo.activity = (aRes && aRes.data) ? aRes.data : [];
    renderOverview();
  }

  function renderOverview(){
    document.getElementById('totalClients').innerText = demo.clients.length;
    document.getElementById('clientsActive').innerText = demo.clients.filter(c=>c.status==='active').length;
    document.getElementById('totalProjects').innerText = demo.projects.length;
    document.getElementById('projectsInProgress').innerText = demo.projects.filter(p=>p.status==='inprogress').length;

    const converted = demo.leads.filter(l=>l.status==='converted').length;
    const ratio = Math.round(demo.leads.length ? (converted/demo.leads.length)*100 : 0);
    document.getElementById('leadBarSegment').style.width = (30 + ratio) + '%';

    const actList = document.getElementById('activityList'); actList.innerHTML = "";
    demo.activity.forEach(a=>{
      const el = document.createElement('div'); el.className = 'act-item';
      el.innerHTML = `<div style="display:flex;gap:10px;align-items:center"><div class="avatar">${(a.actor||'U').split(' ').map(x=>x[0]).slice(0,2).join('')}</div><div><div style="font-weight:600;color:#f7fbff">${a.actor||'User'}</div><div class="mini" style="color:rgba(255,255,255,0.7)">${a.detail||''}</div></div></div><div class="mini" style="font-size:12px;color:rgba(255,255,255,0.6)">${a.created_at? new Date(a.created_at).toLocaleString(): ''}</div>`;
      actList.appendChild(el);
    });

    const overdue = demo.projects.filter(p=> p.deadline && new Date(p.deadline) < new Date() && p.status !== 'completed').length;
    const reminders = demo.leads.filter(l=> l.status === 'contacted').length;
    document.getElementById('overdueCount').innerText = overdue;
    document.getElementById('remindersCount').innerText = reminders;

    const dl = document.getElementById('deadlinesList'); dl.innerHTML = "";
    const sorted = demo.projects.slice().sort((a,b)=> new Date(a.deadline || 0) - new Date(b.deadline || 0));
    sorted.forEach(p=>{
      const daysLeft = p.deadline ? Math.ceil((new Date(p.deadline) - new Date()) / (1000*60*60*24)) : 'â€”';
      const item = document.createElement('div'); item.className='dl-item'; item.style.marginBottom='8px';
      item.innerHTML = `<div><div class="deadline-p" style="font-weight:600;color:#f7fbff">${p.title}</div><div class="mini" style="color:rgba(255,255,255,0.7)">${(p.client||p.client_name||'') } Â· â‚¹${p.amount||0}</div></div><div class="mini">${(typeof daysLeft === 'number') ? (daysLeft>=0?daysLeft + 'd':'overdue') : 'â€”'}</div>`;
      dl.appendChild(item);
    });

    const total = (demo.projects||[]).reduce((s,p)=> s + (Number(p.amount)||0), 0);
    document.getElementById('totalRevenueBig').innerText = total.toLocaleString();

    const unread = demo.activity.filter(a => !a.read).length;
    const badge = document.getElementById('notifBadge');
    if(unread>0){ badge.style.display='inline-block'; badge.innerText = unread; } else badge.style.display='none';
  }

  function renderChart(){
    try {
      const ctx = document.getElementById('revenueChart').getContext('2d');
      const labels = ['May','Jun','Jul','Aug','Sep','Oct','Nov'];
      const data = [20000,26000,22000,32000,35000,34000,42000];
      if(window._revenueChart) window._revenueChart.destroy();
      window._revenueChart = new Chart(ctx, { type:'line', data:{ labels, datasets:[{ label:'Revenue', data, borderColor:'#5aa1d0', tension:0.35, borderWidth:2, pointRadius:0 }] }, options:{ plugins:{legend:{display:false}}, scales:{ x:{ ticks:{ color:'rgba(255,255,255,0.45)' }, grid:{ display:false } }, y:{ ticks:{ color:'rgba(255,255,255,0.45)' }, grid:{ color:'rgba(255,255,255,0.02)' } } }, maintainAspectRatio:false }});
    } catch(e){ console.warn('chart', e); }
  }

  document.getElementById('searchInput').addEventListener('input', (e)=> {
    const q = e.target.value.trim().toLowerCase();
    document.querySelector('.title').innerText = q ? `Search: "${q}"` : 'Dashboard';
  });

  const notifyBtn = document.getElementById('notifyBtn');
  const notifDrawer = document.getElementById('notifDrawer');
  notifyBtn.addEventListener('click', async ()=>{
    if(notifDrawer.style.display === 'block'){ notifDrawer.style.display = 'none'; notifDrawer.setAttribute('aria-hidden','true'); return; }
    notifDrawer.innerHTML = '<div style="font-weight:700;margin-bottom:8px">Activity</div>';
    (demo.activity||[]).slice(0,20).forEach(a=>{
      const row = document.createElement('div'); row.style.padding='8px 6px'; row.style.borderBottom='1px solid rgba(255,255,255,0.02)';
      row.innerHTML = `<div style="font-weight:600;color:#f7fbff">${a.actor||'User'}</div><div style="font-size:13px;color:rgba(255,255,255,0.7)">${a.detail||''}</div><div style="font-size:12px;color:rgba(255,255,255,0.54);margin-top:6px">${a.created_at? new Date(a.created_at).toLocaleString():''}</div>`;
      notifDrawer.appendChild(row);
    });
    notifDrawer.style.display = 'block'; notifDrawer.setAttribute('aria-hidden','false');
  });

  document.getElementById('quickAdd').addEventListener('click', async ()=>{
    const name = prompt('Quick Add Client â€” name');
    if(!name) return;
    await insertRow('clients', { name, status:'active', created_at: new Date().toISOString() });
    await logActivity({ type:'client.create', actor: me, detail: `Created ${name}` });
    await loadAll();
  });

  // sticky note (single)
  const big = document.getElementById('stickyText');
  big.addEventListener('input', ()=> localStorage.setItem('studio_big_note', big.innerText));
  const savedBig = localStorage.getItem('studio_big_note'); if(savedBig) big.innerText = savedBig;

  // bootstrap
  await loadAll();
  renderChart();
  setInterval(async () => { await loadAll(); }, 90000);

})();
</script>
</body>
</html>
