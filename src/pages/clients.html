<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Studio Manager — Clients</title>

<link rel="stylesheet" href="../css/tokens.css">
<link rel="stylesheet" href="../css/components.css">
<link rel="stylesheet" href="../css/styles.css">

<style>
/* page tweaks */
:root{ --muted: rgba(255,255,255,0.6); --card-radius:14px; }
html,body{height:100%;margin:0;background:linear-gradient(140deg,#0c252c,#132c33);-webkit-font-smoothing:antialiased;font-family:Inter,system-ui,Roboto;color:#eaf6ff}
.app{max-width:1200px;margin:28px auto;border-radius:18px;display:grid;grid-template-columns:260px 1fr;padding:18px;min-height:76vh;background:linear-gradient(180deg, rgba(255,255,255,0.015), rgba(255,255,255,0.01));border:1px solid rgba(255,255,255,0.03);box-shadow:0 20px 60px rgba(2,10,15,0.6)}
.sidebar{padding:22px;display:flex;flex-direction:column;gap:18px;background:linear-gradient(180deg, rgba(3,12,16,0.6), rgba(2,8,12,0.55));border-radius:12px}
.brand{font-weight:700;font-size:18px}
.nav{display:flex;flex-direction:column;gap:8px;margin-top:6px}
.nav button{all:unset;display:flex;align-items:center;gap:10px;padding:10px;border-radius:10px;color:var(--muted);cursor:pointer}
.nav button.active{background:linear-gradient(180deg, rgba(255,255,255,0.02), rgba(255,255,255,0.01));color:#eaf6ff}
.main{padding:22px;display:grid;grid-template-columns:1fr;gap:20px}
.header{display:flex;justify-content:space-between;align-items:center}
.title{font-size:28px;font-weight:700;margin:0}
.subtitle{color:var(--muted);margin-top:6px}
.toolbar{display:flex;gap:12px;align-items:center}
.input{width:360px;padding:10px;border-radius:10px;background:rgba(255,255,255,0.02);border:1px solid rgba(255,255,255,0.02);color:#eaf6ff}
.grid{display:grid;grid-template-columns:repeat(auto-fit,minmax(260px,1fr));gap:16px;margin-top:12px}
.card{background:linear-gradient(180deg, rgba(255,255,255,0.02), rgba(255,255,255,0.01));border-radius:14px;padding:14px;border:1px solid rgba(255,255,255,0.03);box-shadow:0 8px 26px rgba(2,8,12,0.36);color:var(--muted)}
.card h4{margin:0;color:#eaf6ff}
.meta{font-size:13px;color:var(--muted);margin-top:8px}
.actions{display:flex;gap:8px;margin-top:12px}
.btn-primary{background:#1e90ff;color:#fff;padding:10px 14px;border-radius:8px;border:none;cursor:pointer}
.ghost{background:transparent;color:rgba(255,255,255,.8);border:1px solid rgba(255,255,255,.06);padding:8px 10px;border-radius:8px;cursor:pointer}
.modal-backdrop{position:fixed;inset:0;background:rgba(0,0,0,0.45);display:none;z-index:1200}
.modal{position:fixed;left:50%;top:50%;transform:translate(-50%,-50%);width:720px;max-width:95%;background:linear-gradient(180deg,rgba(255,255,255,0.02),rgba(255,255,255,0.01));border-radius:12px;padding:18px;border:1px solid rgba(255,255,255,0.03);z-index:1300;display:none}
.input, textarea { width:100%; padding:10px; border-radius:8px; border:1px solid rgba(255,255,255,0.04); background:rgba(255,255,255,0.02); color:#eaf6ff }
textarea{min-height:100px}
.confirm-row{display:flex;gap:8px;justify-content:flex-end;margin-top:12px}
@media (max-width:980px){ .app{grid-template-columns:1fr;padding:12px} .main{grid-template-columns:1fr;padding:12px} .grid{grid-template-columns:1fr} .modal{width:95%} }
</style>
</head>
<body>
<div class="app" role="application">
  <aside class="sidebar">
    <div class="brand">Studio Manager</div>
    <nav class="nav">
      <button onclick="location.href='dashboard.html'">Dashboard</button>
      <button onclick="location.href='projects.html'">Projects</button>
      <button onclick="location.href='invoices.html'">Invoices</button>
      <button class="active">Clients</button>
      <button onclick="location.href='leads.html'">Leads</button>
      <button onclick="location.href='portfolio-public.html'">Portfolio</button>
      <button onclick="location.href='team.html'">Team</button>
    </nav>
    <div style="margin-top:auto;">
      <div class="mini" style="margin-bottom:8px;">Logged as <b id="whoAmI">—</b></div>
      <button id="logoutBtn" class="ghost">⟲</button>
    </div>
  </aside>

  <main class="main">
    <div class="header">
      <div>
        <div class="title">Clients</div>
        <div class="subtitle">Manage clients, notes, and linked projects</div>
      </div>
      <div class="toolbar">
        <input id="searchBox" class="input" placeholder="Search clients..." />
        <button id="btnNewClient" class="btn-primary">+ New Client</button>
      </div>
    </div>

    <div id="grid" class="grid" aria-live="polite"></div>
  </main>
</div>

<!-- modal -->
<div id="modalBackdrop" class="modal-backdrop" aria-hidden="true"></div>
<div id="modal" class="modal" role="dialog" aria-modal="true" aria-hidden="true"></div>

<script src="/env.js"></script>
<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js/dist/umd/supabase.min.js"></script>

<script>
/* Clients page — batch 2 production-ready
   - Uses Supabase v2 (auth.getSession)
   - me variable used for activity logging
*/

(async function(){
  const SUPABASE_URL = window.SUPABASE_URL || '';
  const SUPABASE_ANON_KEY = window.SUPABASE_ANON_KEY || '';
  if(!SUPABASE_URL || !SUPABASE_ANON_KEY){ document.body.innerHTML = '<div style="padding:24px;color:#ff9b9b">Missing env.js</div>'; return; }
  const supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

  // session + me
  let me = 'admin';
  try {
    const { data: { session } } = await supabase.auth.getSession();
    if(!session || !session.user) return window.location.href = 'login.html';
    const email = session.user.email || 'admin';
    document.getElementById('whoAmI').innerText = email.split('@')[0] || email;
    me = email;
  } catch(e){ console.error('session err', e); return window.location.href='login.html'; }

  // logout
  document.getElementById('logoutBtn').addEventListener('click', async ()=> {
    await supabase.auth.signOut();
    window.location.href = 'login.html';
  });

  // minimal SM_API helpers
  async function fetchTable(table, opts = {}) {
    let q = supabase.from(table).select(opts.select || '*');
    if(opts.order) q = q.order(opts.order[0], { ascending: !!opts.order[1] });
    if(opts.limit) q = q.limit(opts.limit);
    const { data, error } = await q;
    if(error) console.warn('fetch', table, error);
    return { data, error };
  }
  async function insertRow(table, payload){ const { data, error } = await supabase.from(table).insert(payload).select(); if(error) throw error; return data; }
  async function updateRow(table, idField, idValue, payload){ const { data, error } = await supabase.from(table).update(payload).eq(idField, idValue).select(); if(error) throw error; return data; }
  async function deleteRow(table, idField, idValue){ const { data, error } = await supabase.from(table).delete().eq(idField, idValue).select(); if(error) throw error; return data; }
  async function logActivity({ type, actor, detail }){ try { await supabase.from('activity').insert({ type, actor, detail, created_at: new Date().toISOString() }); } catch(e){ console.warn('logActivity', e); } }

  // modal
  const modal = document.getElementById('modal'), backdrop = document.getElementById('modalBackdrop');
  function openModal(html){
    modal.innerHTML = html;
    backdrop.style.display = 'block'; modal.style.display = 'block';
    backdrop.setAttribute('aria-hidden','false'); modal.setAttribute('aria-hidden','false');
    const first = modal.querySelector('input,textarea,select,button'); if(first) first.focus();
  }
  function closeModal(){ modal.style.display = 'none'; backdrop.style.display = 'none'; modal.innerHTML = ''; backdrop.setAttribute('aria-hidden','true'); modal.setAttribute('aria-hidden','true'); }
  backdrop.addEventListener('click', closeModal);

  function openFormModal({ title='Form', fields=[], onSubmit }){
    const id = 'form-'+Date.now();
    let html = `<div><h3 style="margin:0 0 8px 0">${title}</h3><form id="${id}">`;
    fields.forEach(f=>{
      const val = f.value? f.value : '';
      if(f.type === 'textarea'){
        html += `<label style="display:block;margin-top:8px;font-weight:600">${f.label || f.name}</label><textarea name="${f.name}" placeholder="${f.placeholder||''}">${val}</textarea>`;
      } else {
        html += `<label style="display:block;margin-top:8px;font-weight:600">${f.label || f.name}</label><input class="input" name="${f.name}" type="${f.type||'text'}" placeholder="${f.placeholder||''}" value="${val}" ${f.required? 'required':''} />`;
      }
    });
    html += `<div class="confirm-row"><button type="button" id="cancelBtn" class="ghost">Cancel</button><button type="submit" class="btn-primary">Save</button></div></form></div>`;
    openModal(html);
    const form = document.getElementById(id);
    form.addEventListener('submit', async (e)=>{
      e.preventDefault();
      const formData = new FormData(form);
      const payload = {};
      fields.forEach(f => payload[f.name] = formData.get(f.name));
      try {
        await onSubmit(payload, form);
        closeModal();
      } catch(err){
        alert('Save failed: ' + (err?.message || err));
        console.error(err);
      }
    });
    document.getElementById('cancelBtn').onclick = closeModal;
  }

  // UI + data
  let clients = [];
  async function loadClients(){
    const res = await fetchTable('clients', { order:['created_at', false] });
    clients = (res && res.data) ? res.data : [];
    renderGrid();
  }
  function renderGrid(){
    const grid = document.getElementById('grid'); grid.innerHTML = '';
    const q = (document.getElementById('searchBox').value || '').toLowerCase();
    const visible = clients.filter(c => !q || (c.name||'').toLowerCase().includes(q) || (c.email||'').toLowerCase().includes(q));
    if(!visible.length) { grid.innerHTML = '<div class="card">No clients yet</div>'; return; }
    visible.forEach(c=>{
      const el = document.createElement('div'); el.className='card';
      el.innerHTML = `<h4>${c.name || 'Untitled'}</h4><div class="meta">${c.email? c.email : ''}</div><div class="meta">${c.notes? c.notes : ''}</div><div class="actions"><button class="ghost" data-id="${c.id}" data-action="edit">Edit</button><button class="ghost" data-id="${c.id}" data-action="view">View</button><button class="ghost" data-id="${c.id}" data-action="delete">Delete</button></div>`;
      grid.appendChild(el);
    });
  }

  document.getElementById('searchBox').addEventListener('input', ()=> renderGrid());
  document.getElementById('btnNewClient').addEventListener('click', ()=> {
    openFormModal({
      title:'Add Client',
      fields:[
        { name:'name', label:'Client name', required:true, placeholder:'Acme Co' },
        { name:'email', label:'Email', placeholder:'client@example.com' },
        { name:'phone', label:'Phone', placeholder:'+91 99999 99999' },
        { name:'notes', label:'Notes', type:'textarea', placeholder:'Optional notes' },
        { name:'status', label:'Status', placeholder:'active' }
      ],
      onSubmit: async (payload)=>{
        payload.created_at = new Date().toISOString();
        await insertRow('clients', payload);
        await logActivity({ type:'client.create', actor: me, detail: `Created ${payload.name}` });
        await loadClients();
      }
    });
  });

  document.getElementById('grid').addEventListener('click', async (e)=>{
    const btn = e.target.closest('button'); if(!btn) return;
    const id = btn.dataset.id; const action = btn.dataset.action;
    const item = clients.find(x=> String(x.id) === String(id));
    if(action === 'edit'){
      openFormModal({
        title:'Edit Client',
        fields:[
          { name:'name', label:'Client name', required:true, value: item.name },
          { name:'email', label:'Email', value: item.email },
          { name:'phone', label:'Phone', value: item.phone },
          { name:'notes', label:'Notes', type:'textarea', value: item.notes },
          { name:'status', label:'Status', value: item.status }
        ],
        onSubmit: async (payload)=>{
          payload.updated_at = new Date().toISOString();
          await updateRow('clients','id', item.id, payload);
          await logActivity({ type:'client.update', actor: me, detail: `Updated ${payload.name}` });
          await loadClients();
        }
      });
    } else if(action === 'view'){
      openModal(`<div><h3 style="margin:0 0 8px 0">${item.name}</h3><div style="color:var(--muted)">${item.email||''}</div><div style="margin-top:10px">${item.notes||''}</div><div style="margin-top:12px"><button class="ghost" onclick="document.getElementById('modalBackdrop').click()">Close</button></div></div>`);
    } else if(action === 'delete'){
      if(!confirm(`Permanently delete "${item.name}"? This cannot be undone.`)) return;
      try {
        await deleteRow('clients','id', item.id);
        await logActivity({ type:'client.delete', actor: me, detail: `Deleted ${item.name}` });
        await loadClients();
      } catch(e){ alert('Delete failed'); console.error(e); }
    }
  });

  // init
  await loadClients();

})();
</script>
</body>
</html>